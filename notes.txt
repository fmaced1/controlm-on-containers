
---
Mudar /home/controlm/run_register_controlm.sh

echo run and register controlm agent [$ALIAS] with controlm [$CTM_SERVER], environment [$CTM_ENV] 
ctm provision setup $CTM_SERVER $ALIAS $CTM_AGENT_PORT -f agent-parameters.json

/home/controlm/agent-parameters.json
{
    "connectionInitiator": "AgentToServer"
}

---

/home/controlm/BMCINSTALL/WinInstallHelper.pl

sub get_hostname {
                #don't add any print to std out
                my $host_name_rc=system("cat /proc/sys/kernel/hostname");
                return $host_name_rc;
}


cd /home/controlm/ && bash -x run_register_controlm.sh

#!/bin/bash
#use agent's java for provision setup
PATH=$PATH:~/ctm/JRE_1.8/bin
CTM_ENV=endpoint
CTM_SERVER=ctmhg
CTM_HOSTGROUP=paasteste
CTM_AGENT_PORT=7026
CID=$(cat /proc/self/cgroup | grep -o  -e "docker-.*.scope" | head -n 1 | sed "s/docker-\(.*\).scope/\\1/" | cut -c 1-12)
AGHOST=$(cat /proc/sys/kernel/hostname)
ALIAS=$AGHOST:$CID

cd
source .bash_profile

echo run and register controlm agent [$ALIAS] with controlm [$CTM_SERVER], environment [$CTM_ENV] 
ctm provision setup $CTM_SERVER $ALIAS $CTM_AGENT_PORT -e $CTM_ENV

echo get agent status CTM_SERVER: $CTM_SERVER 
ctm config server:agents::get $CTM_SERVER|grep -A3 -B3 "$ALIAS"

echo add or create a controlm hostgroup [$CTM_HOSTGROUP] with controlm agent [$ALIAS]
ctm config server:hostgroup:agent::add $CTM_SERVER $CTM_HOSTGROUP $ALIAS -e $CTM_ENV

# loop forever
while true; do echo x && sleep 60; done

exit 0

---

sh-4.2$ ctm environment show
current environment: endpoint
environments: {
  "endpoint": {
    "endPoint": "https://srvctmivlbr03:8443/automation-api",
    "user": "x115672"
  }
}

---

sh-4.2$ ctm environment update endpoint endPoint https://srvctmdvlbr01:8443/automation-api
Environment 'endpoint' was updated
endpoint: {"endPoint":"https://srvctmdvlbr01:8443/automation-api","user":"x115672"}

---

sh-4.2$ bash -x run_register_controlm.sh 
+ PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/controlm/ctm/JRE_1.8/bin
+ CTM_ENV=endpoint
+ CTM_SERVER=ctmhg
+ CTM_HOSTGROUP=paasteste
+ CTM_AGENT_PORT=7026
++ cat /proc/self/cgroup
++ cut -c 1-12
++ head -n 1
++ sed 's/docker-\(.*\).scope/\1/'
++ grep -o -e 'docker-.*.scope'
+ CID=c9474dbc26a3
++ cat /proc/sys/kernel/hostname
+ AGHOST=bff-management-170-dcf9v-debug
+ ALIAS=bff-management-170-dcf9v-debug:c9474dbc26a3
+ cd
+ source .bash_profile
++ PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/controlm/ctm/JRE_1.8/bin:/home/controlm/ctm/scripts:/home/controlm/ctm/exe
++ export PATH
++ LD_LIBRARY_PATH=/lib-override:/home/controlm/ctm/exe
++ export LD_LIBRARY_PATH
++ CONTROLM=/home/controlm/ctm
++ export CONTROLM
+ echo run and register controlm agent '[bff-management-170-dcf9v-debug:c9474dbc26a3]' with controlm '[ctmhg],' environment '[endpoint]'
run and register controlm agent [bff-management-170-dcf9v-debug:c9474dbc26a3] with controlm [ctmhg], environment [endpoint]
+ ctm provision setup ctmhg bff-management-170-dcf9v-debug:c9474dbc26a3 7026 -e endpoint
debug:   Locating java command
info:    Located java at:/bin/java
info:    downloading https://srvctmdvlbr01:8443/automation-api/utils/control-m.services.provision-9.19.230.jar into /home/controlm/.ctm/control-m.services.provision-9.19.230.jar
info:    4MB/4MB precent: 100%
debug:   starting command: /bin/java -jar /home/controlm/.ctm/control-m.services.provision-9.19.230.jar -image "" -server https://srvctmdvlbr01:8443/automation-api -action setup -environment endpoint -ctms "ctmhg" -name "bff-management-170-dcf9v-debug:c9474dbc26a3" -port "7026" -cert 0 -file ""
info:    Making SSL trust all certificates and all hostnames
info:    setting server to agent port: 7026
info:    setting agent to server port: 7016
info:    setting agent name (alias): bff-management-170-dcf9v-debug:c9474dbc26a3
info:    setting primary Control-M Server: srvctmdvlbr01.bs.br.bsch
info:    setting authorized Control-M Server host
info:    agent communication type is transientagent configuration ended. restarting agent

info:    adding newly active agent to Control-M Server
error:   Error setting up the image
error:    Agent bff-management-170-dcf9v-debug:c9474dbc26a3 was added but is not available (ping timeout). Check firewall settings if 'server-to-agent' port '7026' is open on the agent host for incoming connections from the server host and 'agent-to-server' port '7016' is open on the server host for incoming connections from the agent host. For additional options refer to the Control-M documentation page 'Persistent connection parameters' (rc=160) (73)
debug:   setup failed: exit code: 73 for '/bin/java -jar /home/controlm/.ctm/control-m.services.provision-9.19.230.jar -image "" -server https://srvctmdvlbr01:8443/automation-api -action setup -environment endpoint -ctms "ctmhg" -name "bff-management-170-dcf9v-debug:c9474dbc26a3" -port "7026" -cert 0 -file ""'
+ echo get agent status CTM_SERVER: ctmhg
get agent status CTM_SERVER: ctmhg
+ ctm config server:agents::get ctmhg
+ grep -A3 -B3 bff-management-170-dcf9v-debug:c9474dbc26a3
+ echo add or create a controlm hostgroup '[paasteste]' with controlm agent '[bff-management-170-dcf9v-debug:c9474dbc26a3]'
add or create a controlm hostgroup [paasteste] with controlm agent [bff-management-170-dcf9v-debug:c9474dbc26a3]
+ ctm config server:hostgroup:agent::add ctmhg paasteste bff-management-170-dcf9v-debug:c9474dbc26a3 -e endpoint
{
  "message": "Successfully added agent bff-management-170-dcf9v-debug:c9474dbc26a3 to hostgroup paasteste on ctmhg",
  "agents": [
    {
      "host": "bff-management-170-dcf9v-debug:c9474dbc26a3"
    }
  ]
}
+ true
+ echo x
x
+ sleep 60
+ true
+ echo x
x
+ sleep 60
+ true
+ echo x
x
+ sleep 60
+ true
+ echo x



/home/controlm/decommission_controlm.sh

#!/bin/bash

CTM_ENV=endpoint
CTM_SERVER=ctmhg
CTM_HOSTGROUP=paasteste
CTM_AGENT_PORT=7026
CID=$(cat /proc/self/cgroup | grep -o  -e "docker-.*.scope" | head -n 1 | sed "s/docker-\(.*\).scope/\\1/" | cut -c 1-12)
AGHOST=$(cat /proc/sys/kernel/hostname)
ALIAS=$AGHOST:$CID

cd
source .bash_profile

echo delete or remove a controlm hostgroup [$CTM_HOSTGROUP] with controlm agent [$ALIAS]
ctm config server:hostgroup:agent::delete $CTM_SERVER $CTM_HOSTGROUP $ALIAS -e $CTM_ENV

echo stop and unregister controlm agent [$ALIAS] with controlm [$CTM_SERVER], environment [$CTM_ENV]
ctm config server:agent::delete $CTM_SERVER $ALIAS

exit 0


---

List agents 
ctm config server:agents::get ctmhg

---

Log com erro

sh-4.2$ bash -x run_register_controlm.sh 
+ PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/controlm/ctm/JRE_1.8/bin
+ CTM_ENV=endpoint
+ CTM_SERVER=ctmhg
+ CTM_HOSTGROUP=paasteste
+ CTM_AGENT_PORT=7026
++ cat /proc/self/cgroup
++ grep -o -e 'docker-.*.scope'
++ head -n 1
++ sed 's/docker-\(.*\).scope/\1/'
++ cut -c 1-12
+ CID=2a275e8a615d
++ cat /proc/sys/kernel/hostname
+ AGHOST=bff-management-171-h5xk5-debug
+ ALIAS=bff-management-171-h5xk5-debug:2a275e8a615d
+ cd
+ source .bash_profile
++ PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/controlm/ctm/JRE_1.8/bin:/home/controlm/ctm/scripts:/home/controlm/ctm/exe
++ export PATH
++ LD_LIBRARY_PATH=/lib-override:/home/controlm/ctm/exe
++ export LD_LIBRARY_PATH
++ CONTROLM=/home/controlm/ctm
++ export CONTROLM
+ echo run and register controlm agent '[bff-management-171-h5xk5-debug:2a275e8a615d]' with controlm '[ctmhg],' environment '[endpoint]'
run and register controlm agent [bff-management-171-h5xk5-debug:2a275e8a615d] with controlm [ctmhg], environment [endpoint]
+ ctm provision setup ctmhg bff-management-171-h5xk5-debug:2a275e8a615d 7026 -e endpoint
debug:   Locating java command
info:    Located java at:/bin/java
info:    downloading https://srvctmdvlbr01:8443/automation-api/utils/control-m.services.provision-9.19.230.jar into /home/controlm/.ctm/control-m.services.provision-9.19.230.jar
info:    4MB/4MB precent: 100%
debug:   starting command: /bin/java -jar /home/controlm/.ctm/control-m.services.provision-9.19.230.jar -image "" -server https://srvctmdvlbr01:8443/automation-api -action setup -environment endpoint -ctms "ctmhg" -name "bff-management-171-h5xk5-debug:2a275e8a615d" -port "7026" -cert 0 -file ""
info:    Making SSL trust all certificates and all hostnames
info:    setting server to agent port: 7026
info:    setting agent to server port: 7016
info:    setting agent name (alias): bff-management-171-h5xk5-debug:2a275e8a615d
info:    setting primary Control-M Server: srvctmdvlbr01.bs.br.bsch
info:    setting authorized Control-M Server host
info:    agent communication type is transient
info:    agent configuration ended. restarting agent
info:    adding newly active agent to Control-M Server
error:   Error setting up the image
error:    Agent bff-management-171-h5xk5-debug:2a275e8a615d was added but is not available (ping timeout). Check firewall settings if 'server-to-agent' port '7026' is open on the agent host for incoming connections from the server host and 'agent-to-server' port '7016' is open on the server host for incoming connections from the agent host. For additional options refer to the Control-M documentation page 'Persistent connection parameters' (rc=160) (73)
debug:   setup failed: exit code: 73 for '/bin/java -jar /home/controlm/.ctm/control-m.services.provision-9.19.230.jar -image "" -server https://srvctmdvlbr01:8443/automation-api -action setup -environment endpoint -ctms "ctmhg" -name "bff-management-171-h5xk5-debug:2a275e8a615d" -port "7026" -cert 0 -file ""'
+ echo get agent status CTM_SERVER: ctmhg
get agent status CTM_SERVER: ctmhg
+ ctm config server:agents::get ctmhg
+ grep -A3 -B3 bff-management-171-h5xk5-debug:2a275e8a615d
+ echo add or create a controlm hostgroup '[paasteste]' with controlm agent '[bff-management-171-h5xk5-debug:2a275e8a615d]'
add or create a controlm hostgroup [paasteste] with controlm agent [bff-management-171-h5xk5-debug:2a275e8a615d]
+ ctm config server:hostgroup:agent::add ctmhg paasteste bff-management-171-h5xk5-debug:2a275e8a615d -e endpoint
{
  "message": "Successfully added agent bff-management-171-h5xk5-debug:2a275e8a615d to hostgroup paasteste on ctmhg",
  "agents": [
    {
      "host": "bff-management-170-dcf9v-debug:c9474dbc26a3"
    },
    {
      "host": "bff-management-171-h5xk5-debug:2a275e8a615d"
    }
  ]
}
+ true
+ echo x
x

---



